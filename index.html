<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Äiá»ƒm danh QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f2f4f7;
      padding: 20px;
      margin: 0;
    }
    h2 {
      color: #333;
      margin-bottom: 10px;
    }
    #reader {
      max-width: 400px;
      margin: 20px auto;
      border: 3px solid #007bff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    #status {
      margin-top: 15px;
      font-size: 17px;
      font-weight: bold;
      padding: 12px;
      border-radius: 8px;
      min-height: 50px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    .success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
    .warning { background: #fff3cd; color: #856404; border: 2px solid #ffeaa7; }
    .info { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
    
    #scannedList {
      margin-top: 30px;
      max-width: 450px;
      margin-left: auto;
      margin-right: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #scannedList h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
    }
    .student-item {
      padding: 12px;
      margin: 8px 0;
      background: #f8f9fa;
      border-left: 5px solid #28a745;
      text-align: left;
      border-radius: 6px;
      transition: transform 0.2s;
    }
    .student-item:hover {
      transform: translateX(5px);
    }
    .student-item.late {
      border-left-color: #ffc107;
      background: #fff9e6;
    }
    #resetBtn {
      margin-top: 15px;
      padding: 10px 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      transition: background 0.3s;
    }
    #resetBtn:hover {
      background: #c82333;
    }
    #startBtn {
      margin: 20px auto;
      padding: 15px 30px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      display: none;
    }
    #startBtn:hover {
      background: #218838;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<h2>ğŸ“± ÄIá»‚M DANH Há»ŒC SINH Báº°NG QR</h2>
<p>GiÃ¡o viÃªn quÃ©t mÃ£ QR há»c sinh</p>

<button id="startBtn" onclick="requestCameraAndStart()">ğŸ¥ Báº­t Camera</button>

<div id="reader"></div>
<div id="status"></div>

<div id="scannedList">
  <h3>âœ… ÄÃ£ Ä‘iá»ƒm danh: <span id="count">0</span></h3>
  <div id="listContent"></div>
  <button id="resetBtn" onclick="resetSession()">ğŸ”„ Äáº·t láº¡i phiÃªn</button>
</div>

<script>
const START_TIME = "07:00";
const API_URL = "https://script.google.com/macros/s/AKfycbxnk0mA-PcUTBtYRmI0adC9ZEqaNnkgiGOT1Oy5hMPE2_ibWrp3B5OWV4t8Kv5HJTrT/exec"; 

let html5QrCode;
let scannedStudents = new Set();
let isProcessing = false;
let cameraStarted = false;

// Ã‚m thanh
function playBeep(success = true) {
  const url = success 
    ? "https://actions.google.com/sounds/v1/alarms/beep_short.ogg"
    : "https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg";
  const audio = new Audio(url);
  audio.play().catch(e => console.log("Audio play failed:", e));
}

// Hiá»ƒn thá»‹ tráº¡ng thÃ¡i
function showStatus(message, type = 'success', duration = 3000) {
  const status = document.getElementById("status");
  status.innerHTML = message;
  status.className = type;
  
  if (duration > 0) {
    setTimeout(() => {
      status.innerHTML = "";
      status.className = "";
    }, duration);
  }
}

// Kiá»ƒm tra Ä‘i trá»…
function checkLate(hhmm) {
  const [h, m] = hhmm.split(":").map(Number);
  const nowMinutes = h * 60 + m;
  const [sh, sm] = START_TIME.split(":").map(Number);
  const startMinutes = sh * 60 + sm;
  return nowMinutes > startMinutes;
}

// Cáº­p nháº­t danh sÃ¡ch
function updateScannedList(maHS, tenHS, lop, isLate) {
  const count = document.getElementById("count");
  const listContent = document.getElementById("listContent");
  
  count.innerText = scannedStudents.size;
  
  const now = new Date();
  const time = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  
  const item = document.createElement('div');
  item.className = `student-item ${isLate ? 'late' : ''}`;
  item.innerHTML = `
    <strong>ğŸ‘¤ ${tenHS}</strong> <small>(${maHS})</small><br>
    <small>ğŸ« Lá»›p: ${lop} | â° ${time} ${isLate ? 'âš ï¸ Trá»…' : 'âœ… ÄÃºng giá»'}</small>
  `;
  
  listContent.insertBefore(item, listContent.firstChild);
}

// Äáº·t láº¡i phiÃªn
function resetSession() {
  if (confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a danh sÃ¡ch Ä‘iá»ƒm danh hiá»‡n táº¡i?")) {
    scannedStudents.clear();
    document.getElementById("count").innerText = "0";
    document.getElementById("listContent").innerHTML = "";
    showStatus("ğŸ”„ ÄÃ£ Ä‘áº·t láº¡i phiÃªn lÃ m viá»‡c", 'info', 2000);
  }
}

// Xá»­ lÃ½ quÃ©t QR
function onScanSuccess(decodedText) {
  if (isProcessing) return;
  
  isProcessing = true;
  setTimeout(() => { isProcessing = false; }, 800);
  
  const data = decodedText.split("|");
  
  if (data.length < 3) {
    playBeep(false);
    showStatus("âŒ MÃ£ QR khÃ´ng há»£p lá»‡!", 'error', 2000);
    return;
  }

  const maHS = data,[object Object],trim();
  const tenHS = data,[object Object],trim();
  const lop = data,[object Object],trim();

  if (!maHS || !tenHS || !lop) {
    playBeep(false);
    showStatus("âŒ ThÃ´ng tin QR khÃ´ng Ä‘áº§y Ä‘á»§!", 'error', 2000);
    return;
  }

  // Kiá»ƒm tra quÃ©t láº·p
  if (scannedStudents.has(maHS)) {
    playBeep(false);
    showStatus(`âš ï¸ <strong>${tenHS}</strong> Ä‘Ã£ Ä‘Æ°á»£c quÃ©t rá»“i!`, 'warning', 2500);
    return;
  }

  showStatus('<div class="loading"></div> Äang xá»­ lÃ½...', 'info', 0);

  const now = new Date();
  const today = now.toISOString().slice(0, 10);
  const time = now.toLocaleTimeString('vi-VN');
  const hhmm = now.toTimeString().slice(0, 5);
  const isLate = checkLate(hhmm);
  const diTre = isLate ? "Äi trá»…" : "ÄÃºng giá»";

  fetch(API_URL, {
    method: "POST",
    headers: {
      "Content-Type": "text/plain" // Thay Ä‘á»•i Ä‘á»ƒ trÃ¡nh CORS preflight
    },
    body: JSON.stringify({
      maHS,
      tenHS,
      lop,
      ngay: today,
      gio: time,
      diTre
    })
  })
  .then(res => res.json())
  .then(result => {
    if (result.status === "exists") {
      playBeep(false);
      showStatus(`âš ï¸ <strong>${tenHS}</strong> Ä‘Ã£ Ä‘iá»ƒm danh hÃ´m nay!`, 'warning', 3000);
    } else if (result.status === "success") {
      scannedStudents.add(maHS);
      playBeep(true);
      showStatus(`âœ… <strong>${tenHS}</strong> - ${diTre}`, 'success', 2500);
      updateScannedList(maHS, tenHS, lop, isLate);
    } else {
      playBeep(false);
      showStatus("âŒ Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh!", 'error', 2000);
    }
  })
  .catch(error => {
    console.error("Error:", error);
    playBeep(false);
    showStatus("âŒ Lá»—i káº¿t ná»‘i! Kiá»ƒm tra máº¡ng.", 'error', 3000);
  });
}

function onScanError(errorMessage) {
  // Silent
}

// YÃŠU Cáº¦U QUYá»€N CAMERA VÃ€ KHá»I Äá»˜NG
async function requestCameraAndStart() {
  const startBtn = document.getElementById("startBtn");
  startBtn.disabled = true;
  startBtn.innerText = "â³ Äang khá»Ÿi Ä‘á»™ng...";
  
  try {
    // BÆ°á»›c 1: YÃªu cáº§u quyá»n truy cáº­p camera
    showStatus('<div class="loading"></div> Äang yÃªu cáº§u quyá»n camera...', 'info', 0);
    
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: "environment" } 
    });
    
    // Dá»«ng stream táº¡m thá»i (chá»‰ Ä‘á»ƒ xin quyá»n)
    stream.getTracks().forEach(track => track.stop());
    
    // BÆ°á»›c 2: Khá»Ÿi Ä‘á»™ng Html5Qrcode
    showStatus('<div class="loading"></div> Äang khá»Ÿi Ä‘á»™ng camera...', 'info', 0);
    
    html5QrCode = new Html5Qrcode("reader");
    
    const cameras = await Html5Qrcode.getCameras();
    
    if (!cameras || cameras.length === 0) {
      throw new Error("KhÃ´ng tÃ¬m tháº¥y camera");
    }
    
    // Chá»n camera (Æ°u tiÃªn camera sau)
    const cameraId = cameras.length > 1 ? cameras,[object Object],id : cameras,[object Object],id;
    
    await html5QrCode.start(
      cameraId,
      {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0
      },
      onScanSuccess,
      onScanError
    );
    
    cameraStarted = true;
    startBtn.style.display = "none";
    showStatus("âœ… Camera Ä‘Ã£ sáºµn sÃ ng! HÃ£y quÃ©t mÃ£ QR", 'success', 3000);
    console.log("âœ… Camera started successfully");
    
  } catch (error) {
    console.error("Camera error:", error);
    startBtn.disabled = false;
    startBtn.innerText = "ğŸ¥ Thá»­ láº¡i";
    
    let errorMsg = "âŒ KhÃ´ng thá»ƒ khá»Ÿi Ä‘á»™ng camera!<br><small>";
    
    if (error.name === "NotAllowedError" || error.name === "PermissionDeniedError") {
      errorMsg += "Báº¡n Ä‘Ã£ tá»« chá»‘i quyá»n camera. Vui lÃ²ng:<br>";
      errorMsg += "1. Nháº¥p vÃ o biá»ƒu tÆ°á»£ng ğŸ”’ trÃªn thanh Ä‘á»‹a chá»‰<br>";
      errorMsg += "2. Cho phÃ©p quyá»n Camera<br>";
      errorMsg += "3. Táº£i láº¡i trang";
    } else if (error.name === "NotFoundError") {
      errorMsg += "KhÃ´ng tÃ¬m tháº¥y camera trÃªn thiáº¿t bá»‹";
    } else if (error.name === "NotReadableError") {
      errorMsg += "Camera Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi á»©ng dá»¥ng khÃ¡c";
    } else {
      errorMsg += error.message || "Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh";
    }
    
    errorMsg += "</small>";
    showStatus(errorMsg, 'error', 0);
  }
}

// Kiá»ƒm tra xem cÃ³ pháº£i HTTPS khÃ´ng
function checkHTTPS() {
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    showStatus("âš ï¸ Camera chá»‰ hoáº¡t Ä‘á»™ng trÃªn HTTPS!", 'warning', 0);
    return false;
  }
  return true;
}

// Khá»Ÿi Ä‘á»™ng khi trang load
window.addEventListener('load', () => {
  if (checkHTTPS()) {
    // Hiá»ƒn thá»‹ nÃºt báº­t camera thay vÃ¬ tá»± Ä‘á»™ng báº­t
    const startBtn = document.getElementById("startBtn");
    startBtn.style.display = "inline-block";
    showStatus("ğŸ‘† Nháº¥n nÃºt Ä‘á»ƒ báº¯t Ä‘áº§u quÃ©t", 'info', 0);
  }
});

// Dá»n dáº¹p khi Ä‘Ã³ng trang
window.addEventListener('beforeunload', () => {
  if (html5QrCode && cameraStarted) {
    html5QrCode.stop().catch(e => console.log(e));
  }
});
</script>

</body>
</html>
