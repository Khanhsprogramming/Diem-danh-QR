<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ƒêi·ªÉm danh QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      font-family: Arial;
      text-align: center;
      background: #f2f4f7;
      padding: 20px;
    }
    #reader {
      max-width: 360px;
      margin: auto;
      border: 2px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    #status {
      margin-top: 15px;
      font-size: 17px;
      font-weight: bold;
      padding: 10px;
      border-radius: 5px;
      min-height: 40px;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
    .info { background: #d1ecf1; color: #0c5460; }
    
    #scannedList {
      margin-top: 20px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #scannedList h3 {
      margin-top: 0;
      color: #333;
    }
    .student-item {
      padding: 8px;
      margin: 5px 0;
      background: #f8f9fa;
      border-left: 4px solid #28a745;
      text-align: left;
      border-radius: 4px;
    }
    .student-item.late {
      border-left-color: #ffc107;
    }
    #resetBtn {
      margin-top: 10px;
      padding: 8px 16px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #resetBtn:hover {
      background: #c82333;
    }
  </style>
</head>
<body>

<h2>ƒêI·ªÇM DANH H·ªåC SINH B·∫∞NG QR</h2>
<p>Gi√°o vi√™n qu√©t m√£ QR h·ªçc sinh</p>

<div id="reader"></div>
<div id="status"></div>

<div id="scannedList">
  <h3>ƒê√£ ƒëi·ªÉm danh: <span id="count">0</span></h3>
  <div id="listContent"></div>
  <button id="resetBtn" onclick="resetSession()">ƒê·∫∑t l·∫°i phi√™n</button>
</div>

<script>
const START_TIME = "07:00";
const API_URL = "https://script.google.com/macros/s/AKfycbxnk0mA-PcUTBtYRmI0adC9ZEqaNnkgiGOT1Oy5hMPE2_ibWrp3B5OWV4t8Kv5HJTrT/exec"; 

let html5QrCode;
let scannedStudents = new Set(); // L∆∞u m√£ h·ªçc sinh ƒë√£ qu√©t trong phi√™n
let isProcessing = false; // NgƒÉn qu√©t qu√° nhanh

// √Çm thanh
function playBeep(success = true) {
  const url = success 
    ? "https://actions.google.com/sounds/v1/alarms/beep_short.ogg"
    : "https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg";
  const audio = new Audio(url);
  audio.play().catch(e => console.log("Audio play failed:", e));
}

// Hi·ªÉn th·ªã tr·∫°ng th√°i
function showStatus(message, type = 'success', duration = 3000) {
  const status = document.getElementById("status");
  status.innerText = message;
  status.className = type;
  
  // T·ª± ƒë·ªông x√≥a sau duration
  if (duration > 0) {
    setTimeout(() => {
      status.innerText = "";
      status.className = "";
    }, duration);
  }
}

// Ki·ªÉm tra ƒëi tr·ªÖ
function checkLate(hhmm) {
  const [h, m] = hhmm.split(":").map(Number);
  const nowMinutes = h * 60 + m;

  const [sh, sm] = START_TIME.split(":").map(Number);
  const startMinutes = sh * 60 + sm;

  return nowMinutes > startMinutes;
}

// C·∫≠p nh·∫≠t danh s√°ch ƒë√£ qu√©t
function updateScannedList(maHS, tenHS, lop, isLate) {
  const count = document.getElementById("count");
  const listContent = document.getElementById("listContent");
  
  count.innerText = scannedStudents.size;
  
  const now = new Date();
  const time = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
  
  const item = document.createElement('div');
  item.className = `student-item ${isLate ? 'late' : ''}`;
  item.innerHTML = `
    <strong>${tenHS}</strong> (${maHS})<br>
    <small>L·ªõp: ${lop} | ${time} ${isLate ? '‚ö†Ô∏è Tr·ªÖ' : '‚úì ƒê√∫ng gi·ªù'}</small>
  `;
  
  // Th√™m v√†o ƒë·∫ßu danh s√°ch
  listContent.insertBefore(item, listContent.firstChild);
}

// ƒê·∫∑t l·∫°i phi√™n l√†m vi·ªác
function resetSession() {
  if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a danh s√°ch ƒëi·ªÉm danh hi·ªán t·∫°i?")) {
    scannedStudents.clear();
    document.getElementById("count").innerText = "0";
    document.getElementById("listContent").innerHTML = "";
    showStatus("üîÑ ƒê√£ ƒë·∫∑t l·∫°i phi√™n l√†m vi·ªác", 'info', 2000);
  }
}

// X·ª≠ l√Ω qu√©t QR
function onScanSuccess(decodedText) {
  // NgƒÉn qu√©t qu√° nhanh (debounce 500ms)
  if (isProcessing) {
    return;
  }
  
  isProcessing = true;
  setTimeout(() => { isProcessing = false; }, 500);
  
  const data = decodedText.split("|");
  
  // Validate format
  if (data.length < 3) {
    playBeep(false);
    showStatus("‚ùå M√£ QR kh√¥ng h·ª£p l·ªá!", 'error');
    return;
  }

  const maHS = data,[object Object],trim();
  const tenHS = data,[object Object],trim();
  const lop = data,[object Object],trim();

  // Validate d·ªØ li·ªáu
  if (!maHS || !tenHS || !lop) {
    playBeep(false);
    showStatus("‚ùå Th√¥ng tin QR kh√¥ng ƒë·∫ßy ƒë·ªß!", 'error');
    return;
  }

  // ‚úÖ KI·ªÇM TRA QU√âT L·∫∂P TRONG PHI√äN
  if (scannedStudents.has(maHS)) {
    playBeep(false);
    showStatus(`‚ö†Ô∏è ${tenHS} ƒë√£ ƒë∆∞·ª£c qu√©t r·ªìi!`, 'warning', 2000);
    return;
  }

  // Hi·ªÉn th·ªã ƒëang x·ª≠ l√Ω
  showStatus("‚è≥ ƒêang x·ª≠ l√Ω...", 'info', 0);

  // L·∫•y th·ªùi gian hi·ªán t·∫°i
  const now = new Date();
  const today = now.toISOString().slice(0, 10);
  const time = now.toLocaleTimeString('vi-VN');
  const hhmm = now.toTimeString().slice(0, 5);
  const isLate = checkLate(hhmm);
  const diTre = isLate ? "ƒêi tr·ªÖ" : "ƒê√∫ng gi·ªù";

  // G·ª≠i l√™n server
  fetch(API_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      maHS,
      tenHS,
      lop,
      ngay: today,
      gio: time,
      diTre
    })
  })
  .then(res => res.json())
  .then(result => {
    if (result.status === "exists") {
      // H·ªçc sinh ƒë√£ ƒëi·ªÉm danh t·ª´ thi·∫øt b·ªã kh√°c ho·∫∑c l·∫ßn tr∆∞·ªõc
      playBeep(false);
      showStatus(`‚ö†Ô∏è ${tenHS} ƒë√£ ƒëi·ªÉm danh h√¥m nay r·ªìi!`, 'warning');
    } else if (result.status === "success") {
      // Th√†nh c√¥ng
      scannedStudents.add(maHS);
      playBeep(true);
      showStatus(`‚úÖ ${tenHS} - ${diTre}`, 'success');
      updateScannedList(maHS, tenHS, lop, isLate);
    } else {
      // L·ªói kh√°c
      playBeep(false);
      showStatus("‚ùå L·ªói kh√¥ng x√°c ƒë·ªãnh!", 'error');
    }
  })
  .catch(error => {
    console.error("Error:", error);
    playBeep(false);
    showStatus("‚ùå L·ªói k·∫øt n·ªëi! Ki·ªÉm tra m·∫°ng.", 'error');
  });
}

// X·ª≠ l√Ω l·ªói qu√©t (kh√¥ng hi·ªÉn th·ªã ƒë·ªÉ tr√°nh spam)
function onScanError(errorMessage) {
  // Silent error handling
}

// Kh·ªüi ƒë·ªông camera
function startCamera() {
  html5QrCode = new Html5Qrcode("reader");

  Html5Qrcode.getCameras()
    .then(cameras => {
      if (cameras && cameras.length > 0) {
        // ∆Øu ti√™n camera sau
        const cameraId = cameras.length > 1 ? cameras,[object Object],id : cameras,[object Object],id;
        
        html5QrCode.start(
          cameraId,
          {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
          },
          onScanSuccess,
          onScanError
        )
        .then(() => {
          console.log("‚úÖ Camera started successfully");
          showStatus("üì∑ Camera ƒë√£ s·∫µn s√†ng", 'info', 2000);
        })
        .catch(err => {
          console.error("Unable to start camera:", err);
          showStatus("‚ùå Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông camera", 'error', 0);
        });
      } else {
        showStatus("‚ùå Kh√¥ng t√¨m th·∫•y camera!", 'error', 0);
      }
    })
    .catch(err => {
      console.error("Error getting cameras:", err);
      showStatus("‚ùå L·ªói truy c·∫≠p camera", 'error', 0);
    });
}

// Kh·ªüi ƒë·ªông khi trang load
window.addEventListener('load', startCamera);

// D·ªçn d·∫πp khi ƒë√≥ng trang
window.addEventListener('beforeunload', () => {
  if (html5QrCode) {
    html5QrCode.stop().catch(e => console.log(e));
  }
});
</script>

</body>
</html>
