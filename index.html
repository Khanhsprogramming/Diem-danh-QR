<script>
const START_TIME = "07:00";
const API_URL = "https://script.google.com/macros/s/AKfycbxnk0mA-PcUTBtYRmI0adC9ZEqaNnkgiGOT1Oy5hMPE2_ibWrp3B5OWV4t8Kv5HJTrT/exec"; 

function getTodayKey() {
  return "attendance_" + new Date().toISOString().slice(0, 10);
}

// kiểm tra đã quét hôm nay chưa
function hasScannedToday(maHS) {
  const data = JSON.parse(localStorage.getItem(getTodayKey()) || "[]");
  return data.includes(maHS);
}

// lưu mã đã quét
function saveScanned(maHS) {
  const key = getTodayKey();
  const data = JSON.parse(localStorage.getItem(key) || "[]");
  data.push(maHS);
  localStorage.setItem(key, JSON.stringify(data));
}

// âm thanh beep
function playBeep() {
  const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
  audio.play();
}

// kiểm tra đi trễ
function checkLate(timeStr) {
  const [h, m] = timeStr.split(":").map(Number);
  const nowMinutes = h * 60 + m;

  const [sh, sm] = START_TIME.split(":").map(Number);
  const startMinutes = sh * 60 + sm;

  return nowMinutes > startMinutes ? "Đi trễ" : "Đúng giờ";
}

function onScanSuccess(decodedText) {
  const data = decodedText.split("|");
  const status = document.getElementById("status");

  if (data.length < 3) {
    status.innerText = "❌ Mã QR không hợp lệ";
    return;
  }

  const maHS = data[0];
  const tenHS = data[1];
  const lop = data[2];

  if (hasScannedToday(maHS)) {
    status.innerText = "⚠️ " + tenHS + " đã điểm danh hôm nay";
    return;
  }

  const today = new Date().toISOString().slice(0, 10);
  const now = new Date();
  const time = now.toLocaleTimeString();
  const hhmm = now.toTimeString().slice(0, 5);
  const diTre = checkLate(hhmm);

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      maHS,
      tenHS,
      lop,
      ngay: today,
      gio: time,
      diTre
    })
  })
  .then(res => res.json())
  .then(result => {
    if (result.status === "exists") {
      status.innerText = "⚠️ Học sinh đã điểm danh hôm nay";
    } else {
      saveScanned(maHS);
      playBeep();
      status.innerText = "✅ Điểm danh thành công: " + tenHS + " (" + diTre + ")";
    }
  });
}

// khởi động camera
const html5QrCode = new Html5Qrcode("reader");

Html5Qrcode.getCameras().then(cameras => {
  if (cameras.length) {
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      onScanSuccess
    );
  }
});
</script>
